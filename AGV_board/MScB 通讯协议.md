# MScB 通讯协议

## 一、协议结构

MScB通信为CAN 2.0通信接口，波特率1Mbps，采用扩展帧格式，如下所示：

![MScB_Frame_Distribution](https://img2.imgtp.com/2024/03/07/tojWVSet.png)

所有的数据域中都是MSB在前，LSB在后。

## 二、指令一览

### PID指令类

| 指令ID | 指令参数              | 指令含义             |
|:----:|:-----------------:|:----------------:|
| 0x11 | GET_PID_PARAMETER | 获取某个舵轮的指定 PID 参数 |
| 0x12 | SET_PID_PARAMETER | 设置某个舵轮的指定 PID 参数 |

### 控制命令类

| 指令ID | 指令参数                | 指令含义           |
|:----:|:-------------------:|:--------------:|
| 0x00 | DISABLE_CONTROLLING | 停止MScB所有对舵轮的控制 |
| 0x01 | ENABLE_CONTROLLING  | 开始MScB所有对舵轮的控制 |
| 0x03 | SET_VELOCITY_VECTOR | 设置某个舵轮的 矢量速度   |

### 消息控制类

| 指令ID | 指令参数                    | 指令含义        |
|:----:|:-----------------------:|:-----------:|
| 0x0A | ADD_SUBSCRIBE_VALUE     | 订阅舵轮的某项数据   |
| 0x0B | DELETE_SUBSCRIBED_VALUE | 取消订阅舵轮的某项数据 |
| 0x0C | CHECK_SUBSCRIBE_LIST    | 查询舵轮的订阅消息列表 |

## 三、指令详述

### PID指令类

#### GET_PID_PARAMETER 与 SET_PID_PARAMETER

GET_PID_PARAMETER (0x11) 作用：获取某个舵轮的指定 PID 参数

SET_PID_PARAMETER (0x12) 作用：设置某个舵轮的指定 PID 参数

##### 主机发送数据

| 数据区段                  | 内容                   | 数据类型      |
|:---------------------:|:--------------------:|:---------:|
| cmd_id                | 0x11 / 0x12          | uint8_t:5 |
| 数据区 2 的 Bit15 ~ Bit 8 | term_offset_id（详见下方） | uint8_t   |
| 数据区 2 的 Bit7 ~ Bit 0  | loop_offset_id（详见下方） | uint8_t   |
| 目标 ID                 | 舵轮的 ID               | uint8_t   |
| 数据区 1                 | （无）                  | （无）       |

> 注意是数据区 2 的 Bit 位数，而非拓展帧的 Bit 位数。以下内容同理，恕不再赘述。

| loop_offset_id | 内容                |
|:--------------:|:-----------------:|
| 0x01           | 指定查询/设置转向电机的角度环参数 |
| 0x02           | 指定查询/设置转向电机的速度环参数 |
| 0x03           | 指定查询/设置动力电机的角度环参数 |
| 0x04           | 指定查询/设置动力电机的速度环参数 |

| term_offset_id | 内容                 |
|:--------------:|:------------------:|
| 0x01           | 指定查询/设置 PID 输出环节参数 |
| 0x02           | 指定查询/设置 PID 比例环节参数 |
| 0x03           | 指定查询/设置 PID 积分环节参数 |
| 0x04           | 指定查询/设置 PID 微分环节参数 |

##### 响应数据

| 数据区段                  | 内容                   | 数据类型      |
|:---------------------:|:--------------------:|:---------:|
| cmd_id                | 0x1F                 | uint8_t:5 |
| 数据区 2 的 Bit15 ~ Bit 8 | term_offset_id（详见下方） | uint8_t   |
| 数据区 2 的 Bit7 ~ Bit 0  | loop_offset_id（详见下方） | uint8_t   |
| 目标 ID                 | 舵轮的 ID               | uint8_t   |
| 数据区 1                 | 返回数据（详见下方）           | （详见下方）    |

> 💡    也就是说，MScB响应数据和主机发送的 29Bit 拓展帧相同，仅有 8 Byte 数据帧是不同的，以及将cmd_id变更为0x1f,示意为操作成功

##### PID 输出环节

当查询/设置某个舵轮的指定 PID 输出环节参数时，数据区 1 的内容满足如下：

| 数据区 1 区段        | 内容     | 数据类型    |
|:---------------:|:------:|:-------:|
| Byte 3 ~ Byte 2 | 输出限幅下限 | int16_t |
| Byte 1 ~ Byte 0 | 输出限幅上限 | int16_t |

##### PID 比例环节

当查询/设置某个舵轮的指定 PID 比例环节参数时，数据区 1 的内容满足如下：

| 数据区 1 区段        | 内容                       | 数据类型     |
|:---------------:|:------------------------:|:--------:|
| Byte 3 ~ Byte 2 | 比例环节二次方除数增益(近似为将小数点左移n位) | uint16_t |
| Byte 1 ~ Byte 0 | 比例环节系数$K_p$              | int16_t  |

> 💡    比例环节二次方输出放大幂次数如果是$n$且$n \not = 0$，原$P_{out} = K_p \cdot err$；那么新的$P_{out} = 2^n \cdot K_p \cdot err$

##### PID 积分环节

当查询/设置某个舵轮的指定 PID 积分环节参数时，数据区 1 的内容满足如下：

| 数据区 1 区段        | 内容                          | 数据类型     |
|:---------------:|:---------------------------:|:--------:|
| Byte 7 ~ Byte 6 | 积分环节输出下限                    | uint16_t |
| Byte 5 ~ Byte 4 | 积分环节输出上限                    | int16_t  |
| Byte 3 ~ Byte 2 | 积分环节二次方二次方除数增益(近似为将小数点左移n位) | int16_t  |
| Byte 1 ~ Byte 0 | 积分环节系数$K_i$                 | int16_t  |

##### PID 微分环节

当查询/设置某个舵轮的指定 PID 微分环节参数时，数据区 1 的内容满足如下：

| 数据区 1 区段        | 内容                       | 数据类型     |
|:---------------:|:------------------------:|:--------:|
| Byte 3 ~ Byte 2 | 微分环节二次方除数增益(近似为将小数点左移n位) | uint16_t |
| Byte 1 ~ Byte 0 | 微分环节系数$K_d$              | int16_t  |

### 控制命令类

#### DISABLE_CONTROLLING 与 ENABLE_CONTROLLING

DISABLE_CONTROLLING 的作用：失能舵小板控制部分

ENABLE_CONTROLLING  的作用：使能舵小板控制部分并配置优化模式

> 💡    舵小板初次上电时需要进行 ENABLE_CONTROLLING 操作，已启动其功能

##### 主机发送数据

| 数据区段                  | 内容             | 数据类型      |
|:---------------------:|:--------------:|:---------:|
| cmd_id                | 0x00 / 0x01    | uint8_t:5 |
| 数据区 2 的 Bit15 ~ Bit 8 | arc_mode（详见下方） | uint8_t   |
| 数据区 2 的 Bit7 ~ Bit 0  | deg_mode（详见下方） | uint8_t   |
| 目标 ID                 | 舵轮的 ID         | uint8_t   |
| 数据区 1                 | （无）            | （无）       |

| arc_mode | 内容        |
|:--------:|:---------:|
| 0x00     | 使能优劣弧优化功能 |
| 0x01     | 失能优劣弧优化功能 |

| deg_mode | 内容       |
|:--------:|:--------:|
| 0x00     | 使能角度优化功能 |
| 0x01     | 失能角度优化功能 |

#### 响应数据

| 数据区段                  | 内容       | 数据类型      |
|:---------------------:|:--------:|:---------:|
| cmd_id                | 0x1F     | uint8_t:5 |
| 数据区 2 的 Bit15 ~ Bit 8 | arc_mode | uint8_t   |
| 数据区 2 的 Bit7 ~ Bit 0  | deg_mode | uint8_t   |
| 目标 ID                 | 舵轮的 ID   | uint8_t   |
| 数据区 1                 | 无        | None      |

> 💡    也就是说，MScB响应数据和主机发送的 29Bit 拓展帧相同，仅有cmd_id变更为0x1f,示意为操作成功

#### SET_VELOCITY_VECTOR

SET_VELOCITY_VECTOR 的作用：设定某个舵轮的矢量速度

##### 主机发送数据

| 数据区段                  | 内容         | 数据类型      |
|:---------------------:|:----------:|:---------:|
| cmd_id                | 0x03       | uint8_t:5 |
| 数据区 2 的 Bit15 ~ Bit 8 | 无          | None      |
| 数据区 2 的 Bit7 ~ Bit 0  | 无          | None      |
| 目标 ID                 | 舵轮的 ID     | uint8_t   |
| 数据区 1                 | 发送数据（详见下方） | （详见下方）    |

数据区1的发送内容

| 数据区 1 区段        | 内容                | 数据类型    |
|:---------------:|:-----------------:|:-------:|
| Byte 3 ~ Byte 2 | protocol_speed    | int16_t |
| Byte 1 ~ Byte 0 | protocol_position | int16_t |

#### 响应数据

| 数据区段                  | 内容     | 数据类型      |
|:---------------------:|:------:|:---------:|
| cmd_id                | 0x1F   | uint8_t:5 |
| 数据区 2 的 Bit15 ~ Bit 8 | 无      | None      |
| 数据区 2 的 Bit7 ~ Bit 0  | 无      | None      |
| 目标 ID                 | 舵轮的 ID | uint8_t   |
| 数据区 1                 | （无）    | （无）       |

> 💡    也就是说，MScB响应数据和主机发送的 29Bit 拓展帧相同，仅有cmd_id变更为0x1f,示意为操作成功

### 消息控制类

#### ADD_SUBSCRIBE_VALUE

ADD_SUBSCRIBE_VALUE作用：订阅舵轮的某项数据

订阅：让舵轮的某项数据按照某种规则由MScB进行发送，而无需主动发起查询申请。

##### 主机发送数据

| 数据区段                   | 内容                                  | 数据类型      |
|:----------------------:|:-----------------------------------:|:---------:|
| cmd_id                 | 0x0A                                | uint8_t:5 |
| 数据区 2 的 Bit 15 ~ Bit 8 | subscribe_content_2_offset_id（详见下方） | uint8_t   |
| 数据区 2 的 Bit 7 ~ Bit 0  | subscribe_content_1_offset_id（详见下方） | uint8_t   |
| 目标 ID                  | 舵轮的 ID                              | uint8_t   |
| 数据区 1                  | 订阅规则（详见下方）                          | （详见下方）    |

| subscribe_content_x_offset_id | 订阅内容         | 数据类型       |
|:-----------------------------:|:------------:|:----------:|
| 0x01                          | 动力部分 RPM     | uint16_t   |
| 0x02                          | 转向部分角度 LSB   | uint16_t   |
| 0x03                          | 动力电机转矩电流 LSB | int16_t:13 |
| 0x04                          | 转向电机转矩电流 LSB | int16_t:13 |

| 数据区 1 区段        | 内容                                    | 数据类型     |
|:---------------:|:-------------------------------------:|:--------:|
| Byte 7 ~ Byte 6 | content_2_offset_id对应订阅内容的回传次数        | uint16_t |
| Byte 5 ~ Byte 4 | content_2_offset_id对应订阅内容的回传周期 (tick) | uint16_t |
| Byte 3 ~ Byte 2 | content_1_offset_id对应订阅内容的回传次数        | uint16_t |
| Byte 1 ~ Byte 0 | content_1_offset_id对应订阅内容的回传周期 (tick) | uint16_t |

> 当回传次数为0时，表示对应订阅内容回传次数为无限。
> 
> 订阅内容最多可以有8项，订阅内容不能重复。
> 
> 默认先尝试订阅content_1_offset_id对应订阅内容，再尝试订阅content_2_offset_id对应订阅内容。
> 
> tick 由 MScB调度任务的速度决定。

##### 响应数据

MScB响应数据和主机发送的 29Bit 拓展帧相同，仅有cmd_id变更为0x1f,示意为操作成功



#### 订阅消息回传数据

| 数据区段                   | 内容                        | 数据类型      |
|:----------------------:|:-------------------------:|:---------:|
| cmd_id                 | 0x1E                      | uint8_t:5 |
| 数据区 2 的 Bit 15 ~ Bit 8 | content_2_offset_id（详见前述） | uint8_t   |
| 数据区 2 的 Bit 7 ~ Bit 0  | content_1_offset_id（详见前述） | uint8_t   |
| 目标 ID                  | 舵轮的 ID                    | uint8_t   |
| 数据区 1                  | 订阅规则（详见下方）                | （详见下方）    |

| 数据区 1 区段        | 内容                            | 数据类型    |
|:---------------:|:-----------------------------:|:-------:|
| Byte 7 ~ Byte4  | content_2_offset_id对应订阅内容的回传值 | 由订阅内容决定 |
| Byte 3 ~ Byte 0 | content_1_offset_id对应订阅内容的回传值 | 由订阅内容决定 |

#### DELETE_SUBSCRIBE_VALUE

##### 主机发送数据

| 数据区段                   | 内容                               | 数据类型      |
|:----------------------:|:--------------------------------:|:---------:|
| cmd_id                 | 0x0B                             | uint8_t:5 |
| 数据区 2 的 Bit 15 ~ Bit 8 | （无）                              | （无）       |
| 数据区 2 的 Bit 7 ~ Bit 0  | subscribe_delete_offset_id（详见下方） | uint8_t   |
| 目标 ID                  | 舵轮的 ID                           | uint8_t   |
| 数据区 1                  | 删除规则（详见下方）                       | （详见下方）    |

> 当且仅当subscribe_delete_offset_id为零时，数据区 1 中的删除规则才会生效。否则会遵循如下的规则。

| Bit 位数 | 7                | ... | 2                | 1                | 0                |
|:------:|:----------------:|:---:|:----------------:|:----------------:|:----------------:|
| 作用     | 为1时，不再订阅列表第7位的内容 | ... | 为1时，不再订阅列表第2位的内容 | 为1时，不再订阅列表第1位的内容 | 为1时，不再订阅列表第0位的内容 |

当subscribe_delete_offset_id为零时：

| 数据区 1 区段 | 内容                                               | 数据类型    |
|:--------:|:------------------------------------------------:|:-------:|
| Byte 7   | 不再订阅列表中，subscribe_content_x_offset_id为Byte 7值的内容 | uint8_t |
| ...      | ...                                              | ...     |
| Byte 1   | 不再订阅列表中，subscribe_content_x_offset_id为Byte 1值的内容 | uint8_t |
| Byte 0   | 不再订阅列表中，subscribe_content_x_offset_id为Byte 0值的内容 | uint8_t |

当数据区 1 区段中的 Byte 为 0 时，不会删除任何订阅内容。

##### 响应数据

MScB响应数据和主机发送的 29Bit 拓展帧相同，仅有cmd_id变更为0x1f,示意为操作成功

#### CHECK_SUBSCRIBE_LIST

#### ADD_SUBSCRIBE_VALUE

ADD_SUBSCRIBE_VALUE作用：订阅舵轮的某项数据

订阅：让舵轮的某项数据按照某种规则由MScB进行发送，而无需主动发起查询申请。

##### 主机发送数据

| 数据区段                   | 内容     | 数据类型      |
|:----------------------:|:------:|:---------:|
| cmd_id                 | 0x0C   | uint8_t:5 |
| 数据区 2 的 Bit 15 ~ Bit 8 | 无      | None      |
| 数据区 2 的 Bit 7 ~ Bit 0  | 无      | None      |
| 目标 ID                  | 舵轮的 ID | uint8_t   |
| 数据区 1                  | 无      | None      |



##### 响应数据

| 数据区段                   | 内容     | 数据类型      |
|:----------------------:|:------:|:---------:|
| cmd_id                 | 0x1F   | uint8_t:5 |
| 数据区 2 的 Bit 15 ~ Bit 8 | 无      | None      |
| 数据区 2 的 Bit 7 ~ Bit 0  | 无      | None      |
| 目标 ID                  | 舵轮的 ID | uint8_t   |
| 数据区 1                  | 队列订阅状态 | 详见下方      |

| 数据区 1 区段 | 内容              | 数据类型    |
|:--------:|:---------------:|:-------:|
| Byte 7   | 订阅队列中位于7位上的订阅事项 | uint8_t |
| ...      | ...             | ...     |
| Byte 1   | 订阅队列中位于1位上的订阅事项 | uint8_t |
| Byte 0   | 订阅队列中位于0位上的订阅事项 | uint8_t |

> 💡    也就是说，MScB响应数据和主机发送的 29Bit 拓展帧相同，仅有 8 Byte 数据帧是不同的，以及将cmd_id变更为0x1f,示意为操作成功


